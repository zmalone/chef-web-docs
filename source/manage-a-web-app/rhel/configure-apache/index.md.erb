---
title: 'Configure Apache'
order: 6
keywords: TODO
layout: lesson
sections: []
next: {heading: Next, partial: next}
time_to_complete: 25 minutes
---
Now let's configure Apache. Here you'll install the Apache package, start its service, create and enable our custom site, and create a default home page for our site.

In [Learn the basics](/tutorials/learn-the-basics/rhel/) and [Manage a node](/tutorials/manage-a-node/rhel/), you wrote a basic Apache cookbook from scratch. For this project, we want to leverage additional Apache features, which would take some effort to set up.

That's where the [httpd](https://supermarket.chef.io/cookbooks/httpd) cookbook on Chef Supermarket comes in. The `httpd` cookbook provides common functionality such as setting up virtual hosting so you don't have to reinvent the wheel.

[START_BOX]

## 1. Reference the httpd cookbook

As you did for the `selinux` and `firewall` cookbooks, add the dependency for the `httpd` cookbook to your <code class="file-path">metadata.rb</code>, making the entire file look like this.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/metadata.rb
name 'awesome_customers_rhel'
maintainer 'The Authors'
maintainer_email 'you@example.com'
license 'all_rights'
description 'Installs/Configures awesome_customers_rhel'
long_description 'Installs/Configures awesome_customers_rhel'
version '0.1.0'

depends 'selinux', '~> 0.9'
depends 'firewall', '~> 2.5'
depends 'httpd', '~> 0.4'
```

Remember, you can get the latest version of a community cookbook from its page on Chef Supermarket or by running the `knife supermarket show` command, like this.

```bash
# ~/learn-chef
$ knife supermarket show httpd | grep latest_version
latest_version:       https://supermarket.chef.io/api/v1/cookbooks/httpd/versions/0.4.4
```

[END_BOX]

[START_BOX]

## 2. Write the web recipe

Remember, our goals for configuring Apache are to:

* install the Apache package and start and enable its service.
* create and enable our custom site.
* create a default home page for our site.

We'll call our custom site `customers`, and we'll store it in the <code class="file-path">/var/www/customers/public_html</code> directory.

The first step is to create the recipe file, <code class="file-path">web.rb</code>. Run the following command to generate it.

```bash
# ~/learn-chef/cookbooks/awesome_customers_rhel
$ cd ~/learn-chef
$ chef generate recipe cookbooks/awesome_customers_rhel web
Installing Cookbook Gems:
Compiling Cookbooks...
Recipe: code_generator::recipe
  * directory[cookbooks/awesome_customers_rhel/spec/unit/recipes] action create (up to date)
  * cookbook_file[cookbooks/awesome_customers_rhel/spec/spec_helper.rb] action create_if_missing (up to date)
  * template[cookbooks/awesome_customers_rhel/spec/unit/recipes/web_spec.rb] action create_if_missing
    - create new file cookbooks/awesome_customers_rhel/spec/unit/recipes/web_spec.rb
    - update content in file cookbooks/awesome_customers_rhel/spec/unit/recipes/web_spec.rb from none to a449dd
    (diff output suppressed by config)
  * template[cookbooks/awesome_customers_rhel/recipes/web.rb] action create
    - create new file cookbooks/awesome_customers_rhel/recipes/web.rb
    - update content in file cookbooks/awesome_customers_rhel/recipes/web.rb from none to 8f89ec
    (diff output suppressed by config)
```

Although we're not yet set up to run PHP code, we can create an initial home page named <code class="file-path">index.html</code> that contains plain HTML as a placeholder. Earlier, we set up a user, `web_admin`, who has access to the site's content. We'll configure the home page so that the `web_admin` user has read and write access, and everyone else has read-only access.

We'll use the `httpd_service` and `httpd_config` resources, which are defined by the `httpd` cookbook, to set up the `customer` site.

The `httpd_service` resource ensures that the Apache package is installed and gets the service up and running. The `httpd_config` resource copies the configuration file for the `customers` site to the appropriate location. For the home page, we'll use the `file` resource that you're already familiar with.

Write out <code class="file-path">web.rb</code> like this.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/recipes/web.rb
# Install Apache and start the service.
httpd_service 'customers' do
  mpm 'prefork'
  action [:create, :start]
end

# Add the site configuration.
httpd_config 'customers' do
  instance 'customers'
  source 'customers.conf.erb'
  notifies :restart, 'httpd_service[customers]'
end

# Create the document root directory.
directory '/var/www/customers/public_html' do
  recursive true
end

# Write the home page.
file '/var/www/customers/public_html/index.html' do
  content '<html>This is a placeholder</html>'
  mode '0644'
  owner 'web_admin'
  group 'web_admin'
end
```

The `httpd_service` resource supports multiple simultaneous Apache instances that you can identify and manage. The name `customers` will produce a service named `httpd-customers`.

[COMMENT] PHP [must be run](http://www.php.net/manual/en/faq.installation.php#faq.installation.apache2) in a single-threaded [Multi-Processing Module](http://httpd.apache.org/docs/2.2/mpm.html), or MPM. Therefore, we set the `mpm` attribute to use the [prefork](http://httpd.apache.org/docs/2.2/mod/prefork.html) module.

[END_BOX]

[START_BOX]

## 3. Refactor the web recipe

For this project, let's say that the location of the home page &ndash; <code class="file-path">/var/www/customers/public_html</code> &ndash; and its owner &ndash; `web_admin` &ndash; might change. To make this recipe more manageable, let's factor out those parts into custom node attributes.

To do so, you'll go back to your attributes file, <code class="file-path">default.rb</code>, and create a few custom attributes to describe these parts.

We've already defined the user name and group for your site's content. Let's add another node attribute that defines the path to the document root.

Append a node attribute to your default attributes file <code class="file-path">default.rb</code>, making the entire file look like this.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/attributes/default.rb
default['firewall']['allow_ssh'] = true
default['firewall']['firewalld']['permanent'] = true
default['awesome_customers_rhel']['open_ports'] = 80

default['awesome_customers_rhel']['user'] = 'web_admin'
default['awesome_customers_rhel']['group'] = 'web_admin'
default['awesome_customers_rhel']['document_root'] = '/var/www/customers/public_html'
```

Now we have values to use in our recipe. Now go back and modify <code class="file-path">web.rb</code> like this.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/recipes/web.rb
# Install Apache and start the service.
httpd_service 'customers' do
  mpm 'prefork'
  action [:create, :start]
end

# Add the site configuration.
httpd_config 'customers' do
  instance 'customers'
  source 'customers.conf.erb'
  notifies :restart, 'httpd_service[customers]'
end

# Create the document root directory.
directory node['awesome_customers_rhel']['document_root'] do
  recursive true
end

# Write the home page.
file "#{node['awesome_customers_rhel']['document_root']}/index.html" do
  content '<html>This is a placeholder</html>'
  mode '0644'
  owner node['awesome_customers_rhel']['user']
  group node['awesome_customers_rhel']['group']
end
```

The `web` recipe now uses the node attributes for the user and group names and the document root.

[RUBY] The `"#{}"` notation specifies that _string interpolation_ should be performed. String interpolation enables you to replace placeholders within a string with the values they represent. Placeholders can be variables or any block of Ruby code.

[END_BOX]

[START_BOX]

## 4. Create the configuration file

In your recipe you referenced your Apache site's configuration file. Now we need to create this file. We'll do that by creating a Chef template so we can provide placeholders that are filled in with custom node attributes when the recipe runs.

First, run this command to create your template file, <code class="file-path">customers.conf.erb</code>.

```bash
# ~/learn-chef
$ chef generate template cookbooks/awesome_customers_rhel customers.conf
Installing Cookbook Gems:
Compiling Cookbooks...
Recipe: code_generator::template
  * directory[cookbooks/awesome_customers_rhel/templates] action create
    - create new directory cookbooks/awesome_customers_rhel/templates
  * template[cookbooks/awesome_customers_rhel/templates/customers.conf.erb] action create
    - create new file cookbooks/awesome_customers_rhel/templates/customers.conf.erb
    - update content in file cookbooks/awesome_customers_rhel/templates/customers.conf.erb from none to e3b0c4
    (diff output suppressed by config)
```

This command adds the template file <code class="file-path">customers.conf.erb</code> to the<br><code class="file-path">~/learn-chef/cookbooks/awesome\_customers_rhel/templates</code> directory. Remember, the <code class="file-path">.erb</code> extension means that the file can hold placeholders that are filled in when the recipe runs. That's what makes the file a template.

Add this to <code class="file-path">customers.conf.erb</code>.

<%= partial 'customers-conf' %>

The configuration file uses two node attributes &ndash; `node['hostname']` and `node['awesome_customers_rhel']['document_root']`.

`node['hostname']` is one of many [built-in node attributes](https://docs.chef.io/ohai.html#automatic-attributes) that Chef provides for you. This attribute defines the node's host name.

`node['awesome_customers_rhel']['document_root']` defines the site's document root, and is the node attribute that you used in the previous step to set up the home page.

[END_BOX]

[START_BOX]

## 5. Set the web recipe to run

To run the `web` recipe, append an `include_recipe` line to your cookbook's default recipe, just like you did for your `user` recipe. Make the entire default recipe look like this.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/recipes/default.rb
include_recipe 'selinux::permissive'
include_recipe 'awesome_customers_rhel::firewall'
include_recipe 'awesome_customers_rhel::web_user'
include_recipe 'awesome_customers_rhel::web'
```

[END_BOX]

[START_BOX]

## 6. Apply and verify the configuration

Like you did previously, run the cookbook and verify that it's configured as we expect. Run `kitchen converge` to apply the `awesome_customers_rhel` cookbook.

```bash
# ~/learn-chef/cookbooks/awesome_customers_rhel
$ kitchen converge
-----> Starting Kitchen (v1.7.2)
-----> Converging <default-centos-72>...
       Preparing files for transfer
       Preparing dna.json
       Resolving cookbook dependencies with Berkshelf 4.3.2...
       Removing non-cookbook files before transfer
       Preparing validation.pem
       Preparing client.rb
-----> Chef Omnibus installation detected (install only if missing)
       Transferring files to <default-centos-72>
       Starting Chef Client, version 12.9.38
       resolving cookbooks for run list: ["awesome_customers_rhel::default"]
       Synchronizing Cookbooks:
         - httpd (0.4.4)
         - compat_resource (12.7.0)
         - selinux (0.9.0)
         - firewall (2.5.2)
         - awesome_customers_rhel (0.1.0)
         - chef-sugar (3.3.0)
       Compiling Cookbooks...
[...]
            * yum_package[httpd] action install
             - install version 2.4.6-40.el7.centos of package httpd
           * service[httpd] action stop (up to date)
           * service[httpd] action disable (up to date)
[...]
         * httpd_config_rhel[customers] action create
           * directory[/etc/httpd-customers/conf.d] action create (up to date)
           * template[/etc/httpd-customers/conf.d/customers.conf] action create
             - create new file /etc/httpd-customers/conf.d/customers.conf
             - update content in file /etc/httpd-customers/conf.d/customers.conf from none to 3e5f59
             --- /etc/httpd-customers/conf.d/customers.conf	2016-04-25 01:41:13.016051500 +0000
             +++ /etc/httpd-customers/conf.d/.chef-customers.conf20160425-27486-14t8i3u	2016-04-25 01:41:13.014050500 +0000
             @@ -1 +1,27 @@
             +<VirtualHost *:80>
             +  ServerName default-centos-72
             +  ServerAdmin 'ops@example.com'
             +
             +  DocumentRoot /var/www/customers/public_html
             +  <Directory "/">
             +          Options FollowSymLinks
             +          AllowOverride None
             +  </Directory>
             +  <Directory /var/www/customers/public_html >
             +          Options Indexes FollowSymLinks MultiViews
             +          AllowOverride None
             +          Require all granted
             +  </Directory>
             +
             +  ErrorLog /var/log/httpd/error.log
             +
             +  LogLevel warn
             +
             +  CustomLog /var/log/httpd/access.log combined
             +  ServerSignature Off
             +
             +  AddType application/x-httpd-php .php
             +  AddType application/x-httpd-php-source .phps
             +  DirectoryIndex index.php index.html
             +</VirtualHost>
             - change mode from '' to '0644'
             - change owner from '' to 'root'
             - change group from '' to 'root'
             - restore selinux security context

         * directory[/var/www/customers/public_html] action create
           - create new directory /var/www/customers/public_html
           - restore selinux security context
         * file[/var/www/customers/public_html/index.html] action create
           - create new file /var/www/customers/public_html/index.html
           - update content in file /var/www/customers/public_html/index.html from none to a02c68
           --- /var/www/customers/public_html/index.html	2016-04-25 01:41:13.077082000 +0000
           +++ /var/www/customers/public_html/.chef-index.html20160425-27486-10pd1r9	2016-04-25 01:41:13.076081500 +0000
           @@ -1 +1,2 @@
           +<html>This is a placeholder</html>
           - change mode from '' to '0644'
           - change owner from '' to 'web_admin'
           - change group from '' to 'web_admin'
           - restore selinux security context
[...]
       Recipe: awesome_customers_rhel::web
         * httpd_service_rhel_systemd[customers] action restart
           * service[httpd-customers] action restart
             - restart service service[httpd-customers]


       Running handlers:
       Running handlers complete
       Chef Client finished, 81/152 resources updated in 33 seconds
       Finished converging <default-centos-72> (0m42.46s).
-----> Kitchen is finished. (0m43.11s)
```

You'll see from the output that:

* the Apache package, `httpd` on CentOS, was installed.
* the `httpd-customers` service was started and enabled.
* the Apache configuration template was applied, replacing the specified node attributes with their values.
* the home page was written to <code class="file-path">/var/www/customers/public_html/index.html</code>.
* the `web_admin` user was assigned as owner of the home page file and the file's mode was set to 0644.

Now let's verify the web server configuration. Recall that your Test Kitchen configuration file specifies an IP address of 192.168.33.33 for the instance.

```yaml
# ~/learn-chef/cookbooks/awesome_customers_rhel/.kitchen.yml
---
driver:
  name: vagrant
  network:
    - ["private_network", {ip: "192.168.33.33"}]

provisioner:
  name: chef_zero

platforms:
  - name: centos-7.2

suites:
  - name: default
    run_list:
      - recipe[awesome_customers_rhel::default]
    attributes:
```

From a web browser on your workstation, navigate to http://192.168.33.33. You'll see something like this.

![](misc/manage_customers_placeholder.png)

Now let's log in to the instance and verify that the configuration is exactly as we expect. Run `kitchen login` to log in to your instance.

```bash
# ~/learn-chef/cookbooks/awesome_customers_rhel
$ kitchen login
Last login: Mon Apr 25 01:40:39 2016 from 10.0.2.2
[vagrant@default-centos-72 ~]$
```

First, verify that `web_admin` owns the default home page and that the home page has the proper file mode (0644).

```bash
[vagrant@default-centos-72 ~]$ stat -c "%A (%a) %U %G" /var/www/customers/public_html/index.html
-rw-r--r-- (644) web_admin web_admin
```

Now verify that the `httpd-customers` service is running.

```bash
# ~
[vagrant@default-centos-72 ~]$ sudo service httpd-customers status
Redirecting to /bin/systemctl status  httpd-customers.service
● httpd-customers.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd-customers.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2016-02-02 16:21:55 UTC; 15min ago
  Process: 26986 ExecStop=/bin/kill -WINCH ${MAINPID} (code=exited, status=0/SUCCESS)
  Process: 26776 ExecReload=/usr/sbin/httpd-customers -f /etc/httpd-customers/conf/httpd.conf -k graceful (code=exited, status=0/SUCCESS)
 Main PID: 26991 (httpd-customers)
   Status: "Total requests: 1; Current requests/sec: 0; Current traffic:   0 B/sec"
   CGroup: /system.slice/httpd-customers.service
           ├─26991 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...
           ├─26992 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...
           ├─26993 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...
           ├─26994 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...
           ├─26995 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...
           ├─26996 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...
           └─27000 /usr/sbin/httpd-customers -f /etc/httpd-customers/conf/htt...

Feb 02 16:21:55 default-centos-72 systemd[1]: Starting The Apache HTTP Server...
Feb 02 16:21:55 default-centos-72 systemd[1]: Started The Apache HTTP Server.
Hint: Some lines were ellipsized, use -l to show in full.
```

Finally, verify that the home page is in the location we expect.

```bash
# ~
[vagrant@default-centos-72 ~]$ more /var/www/customers/public_html/index.html
<html>This is a placeholder</html>
```

Now log out.

```bash
# ~
[vagrant@default-centos-72 ~]$ logout
Connection to 127.0.0.1 closed.
```

[COMMENT] So far, you've verified each step manually. But as you add new features, you'll want to ensure that you're not breaking existing functionality. It would become tedious to verify your entire configuration from scratch every time you make a change. In the next tutorial, [Test your infrastructure code](/tutorials/test-your-infrastructure-code/rhel/), you'll learn how to automate the testing process. With automated tests, you write your tests one time and then run them anytime you need to verify that your entire configuration works as expected.

[END_BOX]
